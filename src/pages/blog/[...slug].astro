---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return !data.draft;
  });

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();

const categoryNames = {
  'apothekenplanung': 'Apothekenplanung',
  'praxiseinrichtung': 'Praxiseinrichtung',
  'einrichtungstrends': 'Einrichtungstrends',
  'betriebsoptimierung': 'Betriebsoptimierung',
  'renovierung-modernisierung': 'Renovierung & Modernisierung'
};

const categoryName = categoryNames[post.data.category] || post.data.category;

const seoProps = {
  title: post.data.metaTitle,
  description: post.data.metaDescription,
  canonical: `https://www.apothekeneinrichter.de/blog/${post.slug}`,
  image: post.data.featuredImage
};

// Breadcrumb data
const breadcrumbs = [
  { name: 'Home', href: '/' },
  { name: 'Blog', href: '/blog' },
  { name: categoryName, href: `/blog/${post.data.category}` },
  { name: post.data.title, href: `/blog/${post.slug}` }
];

// Structured data for Article
const articleStructuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.description,
  "image": `https://www.apothekeneinrichter.de${post.data.featuredImage}`,
  "author": {
    "@type": "Person",
    "name": post.data.author,
    "jobTitle": "Expertin für Apothekeneinrichtung",
    "worksFor": {
      "@type": "Organization",
      "name": "Mädler Einrichtungen"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mädler Einrichtungen",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.apothekeneinrichter.de/images/logo.png"
    }
  },
  "datePublished": post.data.publishDate.toISOString(),
  "dateModified": post.data.publishDate.toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.apothekeneinrichter.de/blog/${post.slug}`
  }
};

// Structured data for FAQs
const faqStructuredData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": post.data.faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
};
---

<BaseLayout {...seoProps}>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleStructuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />

  <main class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        {breadcrumbs.map((item, index) => (
          <li class="flex items-center">
            {index > 0 && <span class="mx-2">/</span>}
            {index === breadcrumbs.length - 1 ? (
              <span class="text-gray-900 font-medium line-clamp-1">{item.name}</span>
            ) : (
              <a href={item.href} class="hover:text-blue-600 transition-colors">
                {item.name}
              </a>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-12">
      <div class="mb-6">
        <a
          href={`/blog/${post.data.category}`}
          class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
        >
          {categoryName}
        </a>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
        {post.data.title}
      </h1>

      <div class="flex items-center gap-4 text-gray-600 mb-8">
        <div class="flex items-center gap-2">
          <img
            src="/images/team/rebekka-maedler.jpg"
            alt={post.data.author}
            class="w-10 h-10 rounded-full object-cover"
          />
          <span class="font-medium">{post.data.author}</span>
        </div>
        <span>•</span>
        <time>
          {new Date(post.data.publishDate).toLocaleDateString('de-DE', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
      </div>

      <img
        src={post.data.featuredImage}
        alt={post.data.title}
        class="w-full h-64 md:h-96 object-cover rounded-lg mb-8"
      />
    </header>

    <!-- Article Content -->
    <div class="max-w-4xl mx-auto">
      <div class="prose prose-lg max-w-none">
        <Content />
      </div>

      <!-- FAQs Section -->
      {post.data.faqs && post.data.faqs.length > 0 && (
        <section class="mt-16 bg-gray-50 rounded-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Häufig gestellte Fragen</h2>
          <div class="space-y-6">
            {post.data.faqs.map((faq, index) => (
              <details class="group bg-white rounded-lg p-6 shadow-sm">
                <summary class="flex justify-between items-center cursor-pointer list-none">
                  <h3 class="text-lg font-semibold text-gray-900 pr-4">
                    {faq.question}
                  </h3>
                  <span class="text-gray-400 group-open:rotate-180 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </span>
                </summary>
                <div class="mt-4 pt-4 border-t border-gray-100">
                  <p class="text-gray-600 leading-relaxed">{faq.answer}</p>
                </div>
              </details>
            ))}
          </div>
        </section>
      )}

      <!-- Author Bio -->
      <section class="mt-16 bg-blue-50 rounded-lg p-8">
        <div class="flex flex-col md:flex-row items-start gap-6">
          <img
            src="/images/team/rebekka-maedler.jpg"
            alt="Rebekka Mädler"
            class="w-24 h-24 rounded-full object-cover"
          />
          <div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Über die Autorin</h3>
            <h4 class="text-lg text-blue-600 font-medium mb-3">Rebekka Mädler</h4>
            <p class="text-gray-600 mb-4">
              Als Expertin für Apothekeneinrichtung in dritter Generation bei Mädler Einrichtungen bringe ich über 15 Jahre Erfahrung in der Gestaltung funktionaler und ästhetischer Gesundheitsräume mit. Meine Leidenschaft liegt in der individuellen Beratung und der Umsetzung maßgeschneiderter Lösungen für Apotheken und Praxen.
            </p>
            <a
              href="/kontakt"
              class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium"
            >
              Persönliche Beratung anfragen →
            </a>
          </div>
        </div>
      </section>

      <!-- Related Articles -->
      <section class="mt-16">
        <h3 class="text-2xl font-bold text-gray-900 mb-8">Weitere Artikel in dieser Kategorie</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <a
            href={`/blog/${post.data.category}`}
            class="p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
          >
            <h4 class="font-semibold text-gray-900 mb-2">Alle {categoryName} Artikel</h4>
            <p class="text-gray-600 text-sm">
              Entdecken Sie weitere Expertentipps und Ratgeber von Rebekka Mädler
            </p>
          </a>
          <a
            href="/blog"
            class="p-6 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
          >
            <h4 class="font-semibold text-gray-900 mb-2">Zum Blog-Übersicht</h4>
            <p class="text-gray-600 text-sm">
              Alle Artikel und Kategorien auf einen Blick
            </p>
          </a>
        </div>
      </section>
    </div>
  </main>
</BaseLayout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .prose {
    @apply text-gray-700 leading-relaxed;
  }

  .prose h2 {
    @apply text-2xl font-bold text-gray-900 mt-12 mb-6;
  }

  .prose h3 {
    @apply text-xl font-bold text-gray-900 mt-8 mb-4;
  }

  .prose p {
    @apply mb-6;
  }

  .prose ul, .prose ol {
    @apply mb-6 pl-6;
  }

  .prose li {
    @apply mb-2;
  }

  .prose strong {
    @apply font-semibold text-gray-900;
  }

  .prose em {
    @apply italic;
  }

  .prose blockquote {
    @apply border-l-4 border-blue-200 pl-6 italic text-gray-600 my-6;
  }
</style>