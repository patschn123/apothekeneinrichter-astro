---
import { type CollectionEntry, getCollection, type CollectionConfig } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
    return !data.draft;
  });

  return posts.map((post: CollectionEntry<'blog'>) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();

const categoryNames: Record<string, string> = {
  'apothekenplanung': 'Apothekenplanung',
  'praxiseinrichtung': 'Praxiseinrichtung',
  'einrichtungstrends': 'Einrichtungstrends',
  'betriebsoptimierung': 'Betriebsoptimierung',
  'renovierung-modernisierung': 'Renovierung & Modernisierung'
};

const categoryName = categoryNames[post.data.category] || post.data.category;

const seoProps = {
  title: post.data.metaTitle,
  description: post.data.metaDescription,
  canonical: `https://www.apothekeneinrichter.de/blog/${post.slug}`,
  image: post.data.featuredImage
};

// Breadcrumb data
const breadcrumbs = [
  { name: 'Home', href: '/' },
  { name: 'Blog', href: '/blog' },
  { name: categoryName, href: `/blog/${post.data.category}` },
  { name: post.data.title, href: `/blog/${post.slug}` }
];

// Structured data for Article
const articleStructuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.description,
  "image": `https://www.apothekeneinrichter.de${post.data.featuredImage}`,
  "author": {
    "@type": "Person",
    "name": post.data.author,
    "jobTitle": "Expertin für Apothekeneinrichtung",
    "worksFor": {
      "@type": "Organization",
      "name": "Mädler Einrichtungen"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mädler Einrichtungen",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.apothekeneinrichter.de/images/logo.png"
    }
  },
  "datePublished": post.data.publishDate.toISOString(),
  "dateModified": post.data.publishDate.toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.apothekeneinrichter.de/blog/${post.slug}`
  }
};

// Structured data for FAQs
const faqStructuredData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": post.data.faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
};
---

<BaseLayout {...seoProps}>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleStructuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />

  <Header />

  <main class="section-sm" style="background-color: var(--color-background);">
    <div class="container">
    <!-- Breadcrumbs -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        {breadcrumbs.map((item, index) => (
          <li class="flex items-center">
            {index > 0 && <span class="mx-2">/</span>}
            {index === breadcrumbs.length - 1 ? (
              <span class="text-gray-900 font-medium line-clamp-1">{item.name}</span>
            ) : (
              <a href={item.href} class="hover:text-primary transition-colors">
                {item.name}
              </a>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-12">
      <div class="mb-6">
        <a
          href={`/blog/${post.data.category}`}
          class="inline-block px-3 py-1 bg-secondary text-primary rounded-full text-sm font-medium"
        >
          {categoryName}
        </a>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold text-primary mb-6 leading-tight">
        {post.data.title}
      </h1>

      <div class="flex items-center gap-4 text-secondary mb-8">
        <div class="flex items-center gap-2">
          <img
            src="/images/team/rebekka-maedler.jpg"
            alt={post.data.author}
            class="w-10 h-10 rounded-full object-cover"
          />
          <span class="font-medium">{post.data.author}</span>
        </div>
        <span>•</span>
        <time>
          {new Date(post.data.publishDate).toLocaleDateString('de-DE', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
      </div>

      <div class="image-container">
        <div class="skeleton-image" id="featured-skeleton"></div>
        <img
          src={post.data.featuredImage}
          alt={post.data.title}
          class="w-full h-64 md:h-96 object-cover rounded-lg mb-8 opacity-0 transition-opacity duration-300"
          id="featured-image"
          onload="handleImageLoad(this, 'featured-skeleton')"
          onerror="handleImageError(this, 'featured-skeleton')"
        />
      </div>
    </header>

    <!-- Article Content with TOC -->
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Table of Contents Sidebar -->
        <aside class="lg:col-span-1 order-2 lg:order-1">
          <div class="sticky top-24">
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
              <h3 class="text-lg font-semibold text-primary mb-4">Inhaltsverzeichnis</h3>
              <nav id="toc">
                <!-- TOC will be populated by JavaScript -->
              </nav>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:col-span-3 order-1 lg:order-2">
          <!-- Content Skeleton -->
          <div class="content-skeleton" id="content-skeleton">
            <div class="skeleton-text skeleton-text-title mb-6"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-short mb-6"></div>

            <div class="skeleton-text skeleton-text-heading mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-short mb-6"></div>

            <div class="skeleton-text skeleton-text-heading mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
            <div class="skeleton-text skeleton-text-line mb-4"></div>
          </div>

          <div class="prose prose-lg max-w-none bg-white rounded-lg p-8 shadow-sm opacity-0 transition-opacity duration-500" id="main-content" style="background-color: white !important;">
            <Content />
          </div>

      <!-- FAQs Section -->
      {post.data.faqs && post.data.faqs.length > 0 && (
        <section class="mt-16 bg-gray-50 rounded-lg p-8">
          <h2 class="text-2xl font-bold text-primary mb-8">Häufig gestellte Fragen</h2>
          <div class="space-y-6">
            {post.data.faqs.map((faq, index: number) => (
              <details class="group bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <summary class="flex justify-between items-center cursor-pointer list-none">
                  <h3 class="text-lg font-semibold text-primary pr-4">
                    {faq.question}
                  </h3>
                  <span class="text-text-light group-open:rotate-180 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </span>
                </summary>
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <p class="text-secondary leading-relaxed">{faq.answer}</p>
                </div>
              </details>
            ))}
          </div>
        </section>
      )}

      <!-- Author Bio -->
      <section class="mt-16 bg-secondary rounded-lg p-8">
        <div class="flex flex-col md:flex-row items-start gap-6">
          <div class="image-container relative">
            <div class="skeleton-avatar" id="author-skeleton"></div>
            <img
              src="/images/team/rebekka-maedler.jpg"
              alt="Rebekka Mädler"
              class="w-24 h-24 rounded-full object-cover opacity-0 transition-opacity duration-300"
              id="author-image"
              onload="handleImageLoad(this, 'author-skeleton')"
              onerror="handleImageError(this, 'author-skeleton')"
            />
          </div>
          <div>
            <h3 class="text-xl font-bold text-primary mb-2">Über die Autorin</h3>
            <h4 class="text-lg text-primary font-medium mb-3">Rebekka Mädler</h4>
            <p class="text-secondary mb-4">
              Als Expertin für Apothekeneinrichtung in dritter Generation bei Mädler Einrichtungen bringe ich über 15 Jahre Erfahrung in der Gestaltung funktionaler und ästhetischer Gesundheitsräume mit. Meine Leidenschaft liegt in der individuellen Beratung und der Umsetzung maßgeschneiderter Lösungen für Apotheken und Praxen.
            </p>
            <a
              href="/kontakt"
              class="inline-flex items-center text-primary hover:text-primary-light font-medium"
            >
              Persönliche Beratung anfragen →
            </a>
          </div>
        </div>
      </section>

      <!-- Related Articles -->
      <section class="mt-16">
        <h3 class="text-2xl font-bold text-primary mb-8">Weitere Artikel in dieser Kategorie</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <a
            href={`/blog/${post.data.category}`}
            class="card hover:shadow-lg transition-all"
          >
            <h4 class="font-semibold text-primary mb-2">Alle {categoryName} Artikel</h4>
            <p class="text-secondary text-sm">
              Entdecken Sie weitere Expertentipps und Ratgeber von Rebekka Mädler
            </p>
          </a>
          <a
            href="/blog"
            class="card bg-secondary hover:shadow-lg transition-all"
          >
            <h4 class="font-semibold text-primary mb-2">Zum Blog-Übersicht</h4>
            <p class="text-secondary text-sm">
              Alle Artikel und Kategorien auf einen Blick
            </p>
          </a>
        </div>
      </section>
        </div>
      </div>
    </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  // Table of Contents Generation
  document.addEventListener('DOMContentLoaded', function() {
    const tocContainer = document.getElementById('toc');
    const headings = document.querySelectorAll('.prose h2') as NodeListOf<HTMLElement>;

    if (headings.length === 0) {
      if (tocContainer) {
        tocContainer.innerHTML = '<p class="text-text-light text-sm">Keine Überschriften gefunden</p>';
      }
      return;
    }

    const tocHTML = Array.from(headings)
      .filter(heading => heading.textContent.trim() !== '')
      .map(heading => {
        const id = heading.textContent
          .toLowerCase()
          .replace(/[^a-z0-9äöüß\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();

        heading.id = id;

        return `<a href="#${id}" class="toc-h2">${heading.textContent}</a>`;
      })
      .join('');

    if (tocContainer) {
      tocContainer.innerHTML = tocHTML;
    }

    // Smooth scrolling for TOC links
    if (tocContainer) {
      tocContainer.addEventListener('click', function(e) {
        if (e.target && (e.target as HTMLElement).tagName === 'A') {
          e.preventDefault();
          const targetId = (e.target as HTMLElement).getAttribute('href')?.substring(1);
          if (targetId) {
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
              targetElement.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });

              // Update active state
              tocContainer.querySelectorAll('a').forEach(link => link.classList.remove('active'));
              (e.target as HTMLElement).classList.add('active');
            }
          }
        }
      });
    }

    // Update active TOC item on scroll
    let ticking = false;
    function updateActiveTOC() {
      if (!tocContainer) return; // Early return if tocContainer is null
      
      const scrollPosition = window.scrollY + 120; // Offset for sticky header
      let activeHeading: HTMLElement | null = null;

      headings.forEach(heading => {
        if (heading.offsetTop <= scrollPosition) {
          activeHeading = heading;
        }
      });

      tocContainer.querySelectorAll('a').forEach(link => {
        link.classList.remove('active');
        if (activeHeading && link.getAttribute('href') === `#${activeHeading.id}`) {
          link.classList.add('active');
        }
      });

      ticking = false;
    }

    window.addEventListener('scroll', function() {
      if (!ticking) {
        requestAnimationFrame(updateActiveTOC);
        ticking = true;
      }
    });

    // Set initial active state
    if (tocContainer) {
      updateActiveTOC();
    }
  });

  // Image loading handlers
  function handleImageLoad(img: HTMLImageElement, skeletonId: string) {
    const skeleton = document.getElementById(skeletonId);
    img.style.opacity = '1';
    if (skeleton) {
      skeleton.style.display = 'none';
    }
  }

  function handleImageError(img: HTMLImageElement, skeletonId: string) {
    const skeleton = document.getElementById(skeletonId);
    img.style.display = 'none';
    if (skeleton) {
      skeleton.style.display = 'none';
    }
  }

  // Content loading simulation
  document.addEventListener('DOMContentLoaded', function() {
    // Simulate content loading time
    setTimeout(function() {
      const contentSkeleton = document.getElementById('content-skeleton');
      const mainContent = document.getElementById('main-content');

      if (contentSkeleton && mainContent) {
        contentSkeleton.style.display = 'none';
        mainContent.style.opacity = '1';
      }
    }, 800); // Adjust timing as needed
  });
</script>

<style>
  /* Design tokens from global.css */
  .bg-background { background-color: var(--color-background); }
  .bg-secondary { background-color: var(--color-secondary); }
  .text-primary { color: var(--color-primary); }
  .text-secondary { color: var(--color-text-secondary); }
  .text-text-light { color: var(--color-text-light); }
  .border-border { border-color: var(--color-border); }
  .border-primary { border-color: var(--color-primary); }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .prose {
    color: var(--color-text-secondary) !important;
    line-height: var(--line-height-relaxed);
    background-color: white !important;
  }

  .prose h1, .prose h2 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-top: var(--spacing-3xl);
    margin-bottom: var(--spacing-lg);
  }

  .prose h3 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
  }

  .prose p {
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-secondary) !important;
  }

  .prose ul, .prose ol {
    margin-bottom: var(--spacing-lg);
    padding-left: var(--spacing-xl);
  }

  .prose li {
    margin-bottom: var(--spacing-sm);
  }

  .prose strong {
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
  }

  .prose em {
    font-style: italic;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-xl);
    font-style: italic;
    color: var(--color-text-secondary);
    margin: var(--spacing-xl) 0;
  }

  /* Ensure all content in prose has proper colors */
  #main-content {
    background-color: white !important;
  }

  #main-content * {
    color: inherit;
  }

  #main-content p, #main-content li, #main-content div {
    color: var(--color-text-secondary) !important;
  }

  /* Table of Contents Styles */
  #toc {
    background-color: white;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  #toc a {
    display: block;
    width: 100%;
    padding: var(--spacing-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-sm);
    transition: all var(--transition-fast);
    border-left: 3px solid transparent;
    border: 1px solid #e5e7eb;
    background-color: #fafafa;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  #toc a:hover {
    background-color: #f1f5f9;
    color: var(--color-primary);
    border-left-color: var(--color-accent);
    border-color: var(--color-accent);
    transform: translateX(2px);
  }

  #toc a.active {
    background-color: var(--color-secondary);
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    border-color: var(--color-primary);
    font-weight: var(--font-weight-medium);
  }

  #toc .toc-h2 {
    /* Styles are inherited from #toc a */
  }

  /* Skeleton Loading Styles */
  .skeleton {
    background: linear-gradient(
      90deg,
      var(--color-secondary) 25%,
      var(--color-border) 50%,
      var(--color-secondary) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .skeleton-image {
    @apply skeleton;
    width: 100%;
    height: 16rem; /* h-64 */
    border-radius: var(--border-radius-lg);
    margin-bottom: var(--spacing-2xl);
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }

  @media (min-width: 768px) {
    .skeleton-image {
      height: 24rem; /* md:h-96 */
    }
  }

  .skeleton-avatar {
    @apply skeleton;
    width: 6rem; /* w-24 */
    height: 6rem; /* h-24 */
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }

  .skeleton-text {
    @apply skeleton;
    border-radius: var(--border-radius-sm);
    height: 1rem;
  }

  .skeleton-text-title {
    height: 2.5rem;
    width: 80%;
  }

  .skeleton-text-heading {
    height: 1.5rem;
    width: 60%;
  }

  .skeleton-text-line {
    height: 1rem;
    width: 100%;
  }

  .skeleton-text-short {
    height: 1rem;
    width: 70%;
  }

  .content-skeleton {
    background-color: white;
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
  }

  .image-container {
    position: relative;
    display: inline-block;
  }

  .image-container img {
    position: relative;
    z-index: 2;
  }
</style>